---
title: "Psychophysic Visualization & Analises"
author: "Raúl Rodríguez-Cruces"
date: "20 de febrero de 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# R basic packages
```{r packages, echo=TRUE,message=FALSE, warning=FALSE}
library(gplots)
library(MASS)
library(pander)
library(magrittr)
library(dplyr)
library(ggplot2)
```

# Group Heatmaps
This was created calculating the accuracy of each subject per stimuli. First stimuli where binarized based in the answer for the **Fine structure emotion**, with 1 if is correct and 0 when wrong. The total was divided by the total amount of stimuli or each category (nb0...nb64).  

## Accuracy for both emotions
```{r Heatmap Accuracy, echo=FALSE, warning=FALSE, message=FALSE}
source("/home/rr/git_here/R-plots/R-colors/colormaps_functions.R")
# Set path
home="/home/rr/"
setwd(paste0(home,"git_here/2018_music_psychophysics"))

# Read the Subjects Information
cases <- read.csv("database/cases.csv")

# Reads the subjects Responses
result <- read.csv("database/cases_results.csv")

# Slices Happy and Sad
hap <- result[result$emo=="h",]
sad <- result[result$emo=="s",] 

# Creates a matrix with the Percentage of Correct Responses per FINE STRUCTURE stimuli
calAccu <- function(df){
  accuracy <- c()
  for (i in unique(df$fts)) {
    sub.cases <- df[df$fts==i,]
    X <- apply(sub.cases[,7:70],2,function(x) sum(ifelse(sub.cases$emo.fts == x, 1,0))/length(x) )
    accuracy <- cbind(accuracy,X)
  }
  colnames(accuracy) <- unique(df$fts)
  return(as.matrix(accuracy))  
}
# Color-palette
colG<-c("navy","dodgerblue4","dodgerblue2","deepskyblue","lightskyblue","red","firebrick2","firebrick3","firebrick","firebrick4")
# Color-map
col.map <- optim.color(calAccu(result),colG)
# Heatmap of all subjects, Clustered by Group
heatmap.2(calAccu(result),Colv=FALSE,main= "Fine Structure Accuracy",
          density.info="histogram",
          dendrogram='row',
          trace="none",
          tracecol="white",
          key.title = "Discriminability",     
          col    = col.map$color.palette,   # Colormap
          breaks = col.map$palette.breaks,
          srtCol=1,  
          RowSideColors = c("mediumpurple4","darkolivegreen","darkolivegreen3","mediumpurple")[cases$class])
```
  
  
## HAPPY - Group Heatmap  
Ordered by row clusterization
  
```{r heatmap happy, echo=FALSE}
j=1
Col=c("mediumpurple4","darkolivegreen","darkolivegreen3","mediumpurple")
for (i in levels(cases$class)) {
  indx <- which(cases$class==i)
  heatmap.2(calAccu(hap)[indx,],Colv=FALSE,main= paste(i,"fst-HAP"),
            density.info="histogram",Rowv = TRUE,
            dendrogram='row',
            trace="row",
            tracecol=NA,
            key.title = "Discriminability",     
            col    = col.map$color.palette,   # Colormap
            breaks = col.map$palette.breaks,
            srtCol=1,  
            RowSideColors = rep(Col[j],length(indx)))
  j=j+1
}
```

## SAD - Group Heatmap  
Ordered by row clusterization  

```{r heatmap sad, echo=FALSE}
j=1
Col=c("mediumpurple4","darkolivegreen","darkolivegreen3","mediumpurple")
for (i in levels(cases$class)) {
  indx <- which(cases$class==i)
  heatmap.2(calAccu(sad)[indx,],Colv=FALSE,main= paste(i,"fst-HAP"),
            density.info="histogram",Rowv = TRUE,
            dendrogram='row',
            trace="row",
            tracecol=NA,
            key.title = "Discriminability",     
            col    = col.map$color.palette,   # Colormap
            breaks = col.map$palette.breaks,
            srtCol=1,  
            RowSideColors = rep(Col[j],length(indx)))
  j=j+1
}
```

# Happy vs Sad  

```{r Happy vs sad, echo=FALSE, message=FALSE, warning=FALSE}
# FUNCTION for heatmap plotting
hmap <- function(Mtx, Title){
heatmap.2(Mtx,Colv=FALSE,main= Title,
            density.info="histogram",Rowv = TRUE,
            dendrogram='row',
            trace="row",
            tracecol=NA,
            key.title = "Discriminability",     
            col    = col.map$color.palette,   # Colormap
            breaks = col.map$palette.breaks,
            srtCol=1)}

library(corrplot)
indx <- which(cases$gender=="M")
M.sad <- calAccu(sad)[indx,2:7]
M.hap <- calAccu(hap)[indx,2:7]
indx <- which(cases$gender=="F")
F.sad <- calAccu(sad)[indx,2:7]
F.hap <- calAccu(hap)[indx,2:7]
# Heatmap: Happy-Sad
hmap(M.sad,"Males: SAD")
hmap(F.sad,"Females: SAD")
hmap(M.hap,"Males: HAPPY")
hmap(F.hap,"Females: HAPPY")
```

## Stimuli Correlation for Female-Male | Happy-Sad  
```{r correlation Happy-sad, echo=FALSE, message=FALSE, warning=FALSE}
par(mfrow=c(2,2))
corrplot(cor(M.hap,M.hap), method = "color", type = "upper",  number.cex = 1.5, addCoef.col = "white", tl.col = "black", tl.srt = 90, diag = FALSE,title = "Male Happy")
corrplot(cor(F.hap,F.hap), method = "color", type = "upper",  number.cex = 1.5, addCoef.col = "white", tl.col = "black", tl.srt = 90, diag = FALSE,title = "Female Happy")
corrplot(cor(M.sad,M.sad), method = "color", type = "upper",  number.cex = 1.5, addCoef.col = "white", tl.col = "black", tl.srt = 90, diag = FALSE,title = "Male Sad")
corrplot(cor(F.sad,F.sad), method = "color", type = "upper",  number.cex = 1.5, addCoef.col = "white", tl.col = "black", tl.srt = 90, diag = FALSE,title = "Female Sad")
```

## Lines for all Subjects  
  
```{r Lines-dots, echo=FALSE, warning=FALSE, message=FALSE}
accuracy <- calAccu(result)
blank.plot <- function (X,lab,Main) {
  Ax.Col="black"
  Main <- as.character(Main)
  plot(X,ylim=c(0,1),xlim = c(0,length(X)+1),pch=19,ylab="score",main=Main,col=NA,xaxt='n',bty='n',xlab="",axes = FALSE,
       las=1,col.axis=Ax.Col,col.lab=Ax.Col,col.main=Ax.Col,cex.axis=1.2,cex=seq(0.5,1.5,length.out = 35),cex.main=2)
  polygon(c(0,0,8,8,0),c(0,1,1,0,0),col="gray85",border = NA)
  abline(h=seq(0,1,0.2),lty=1,col="white")
  axis(1, at=1:7, col.axis=Ax.Col,labels=lab, lty=1, col=Ax.Col, las=1,lwd=3,cex.axis=1,col.lab=Ax.Col)
  axis(2, at=seq(0,1,0.2), labels=seq(0,1,0.2), lty=1, col.axis=Ax.Col,las=1,lwd=3,cex.axis=1.2,col.lab=Ax.Col,col=Ax.Col)
}
lines.plot <- function(y,Col,Tilte) {
  x <- apply(y,2,mean)
  blank.plot(x,lab=colnames(accuracy),Main = Tilte)
  apply(y,1, function(x) lines(x,col=Col,lwd=0.5))
  lines(x,col=Col,lwd=2.5)
  points(x,bg=Col,lwd=2,cex=1.5,pch=21,col="white")
  
}
par(mfrow=c(2,2))
# FEMALE PERFORMANCE
lines.plot(accuracy[cases$class == "poor" & cases$gender=="M",],"mediumpurple", "Poor Male")
lines.plot(accuracy[cases$class == "poor" & cases$gender=="F",],"mediumpurple", "Poor Female")
# MALE PERFORMANCE
lines.plot(accuracy[cases$class == "best" & cases$gender=="M",],"mediumpurple4", "Best Male")
lines.plot(accuracy[cases$class == "best" & cases$gender=="F",],"mediumpurple4", "Best Female")
# HIGH PERFORMANCE
lines.plot(accuracy[cases$class == "high" & cases$gender=="M",],"darkolivegreen", "High Male")
lines.plot(accuracy[cases$class == "high" & cases$gender=="F",],"darkolivegreen", "High Female")
# LOW PERFORMANCE
lines.plot(accuracy[cases$class == "low" & cases$gender=="M",],"darkolivegreen3", "Low Male")
lines.plot(accuracy[cases$class == "low" & cases$gender=="F",],"darkolivegreen3", "Low Female")


```

# Linear Discriminant Analysis  
I ran the LDA analysis again using nb0 aand without the age.  
$Group~nb0+nb2+nb4+nb8+nb16+nb32+nb64$  
```{r lda, echo=FALSE,warning=FALSE,message=FALSE}
#### LINEAR DISCRIMINANT ANALYSIS ####
# Data Reshape
d <- data.frame(cbind(cases$class,cases$age,cases$music.yrs,cases$gender,accuracy)) 
colnames(d) <- c("type","age","music.yrs","gender","nb0","nb2","nb4","nb8","nb16","nb32","nb64")
d$type <- cases$class
d$id <- rownames(d)
# Linear Discriminant model MASS library
m <- lda(type~nb0+nb2+nb4+nb8+nb16+nb32+nb64, d)
# Obtains the predictor from the LDA to an object
p <- predict(m)
# Accuracy of prediction
freqtable <- table(p$class, d$type)
# Percent correct of each category of G
diag(prop.table(freqtable))
rownames(freqtable) <- paste0("Predicted ", d$type %>% levels)
freqtable %>% addmargins %>% pander("Observed vs. Predicted Frequencies")
# Total percent correct
sum(diag(prop.table(freqtable)))
# Proportions
prop.table(freqtable) %>% addmargins %>% pander("Proportions")
# LDA, 3  used: 
#plot(m, abbrev=1,dimen = 3)
# LDA to variables
d$LDA1 <- p$x[,1]
d$LDA2 <- p$x[,2]
d$LDA3 <- p$x[,3]
# LDA functions distributions
ggplot(d, aes(LDA1, fill = type)) + geom_density(alpha = 0.5, color = NA) + theme(legend.position = "top")
ggplot(d, aes(LDA2, fill = type)) + geom_density(alpha = 0.5, color = NA) + theme(legend.position = "top")
ggplot(d, aes(LDA3, fill = type)) + geom_density(alpha = 0.5, color = NA) + theme(legend.position = "top")
# Table
gMeans <- d %>% group_by(type) %>% select(LDA1,LDA2,LDA3) %>%  summarise_each(funs(mean)) 
gMeans %>% pander
# FIRST two LDA
ggplot(d, aes(LDA1, LDA2, color = type)) + 
  geom_point(alpha = 0.5) + 
  geom_text(data = gMeans, 
            aes(label = type),
            color = "black", 
            vjust = 1.75) + 
  geom_point(data = gMeans, 
             aes(fill = type), 
             size = 4, 
             color = "black", 
             pch = 21) + 
  theme(legend.position = "none") +
  coord_equal()

# PLots the LDA
library(scatterplot3d)
source('http://www.sthda.com/sthda/RDoc/functions/addgrids3d.r')
scatterplot3d(d$LDA1,d$LDA2,d$LDA3,color = c("red","green","blue","orange")[d$type],pch = 19,box = FALSE,main = "Linear Discriminant Functions", xlab = "LDA1", ylab = "LDA2", zlab = "LDA3")
addgrids3d(d$LDA1,d$LDA2,d$LDA3, grid = c("xy", "xz", "yz"))

par(mfrow=c(1,2))
library(klaR)
drawparti(grouping = d$type, x = d$LDA1, y = d$LDA2, xlab = "LDA1", ylab = "LDA2")
drawparti(grouping = d$type, x = d$LDA2, y = d$LDA3, xlab = "LDA2", ylab = "LDA3")
# Panels of histograms and overlayed density plots


# Scatterplot for 3 Group Problem
#pairs(d[c("nb2","nb4","nb8","nb16","nb32","nb64")], main="LDA Accuracy", pch=22, bg=c("red","green","blue","orange")[unclass(d$type)])

```

```{r, echo=FALSE}
plot(m, dimen=1, type="both") # m is the fit from lda 
```
  
## Cannonical Discriminant Variables
```{r cdv, echo=FALSE,warning=FALSE,message=FALSE}
# MANOVA follow up
library(tables)
m <- lm(cbind(nb0, nb2, nb4, nb8, nb16, nb32, nb64) ~ type, d)
#etasq(m %>% manova)
#par(mfrow=c(1,1))
#heplot(m,variables =)
# Canonical Function analysis
library(candisc)
cca <- m %>% candisc 
cca %>% summary(coef = c("raw", "std", "structure"))

# RAW Coefficients
cca$coeffs.raw %>% pander("Raw Coefficients")
# STANDARIZED coefficients
cca$coeffs.std %>% pander("Standardized Coefficients")
# STRUCTURE Coefficients
cca$structure %>% pander("Structure Coefficients")

# CANNONICAL DISCRIMINANT ANALYSIS
par(xpd = T, bty = "n",pty = "s")
heplot(cca)

myColors <- hsv((c(0,80,160,240) + 80)/360,s = 0.8,v = 0.8,0.7)
#cca %>% plot(col = myColors, pch = rep(16,4), bty = "n", xpd = T)
plot(cca, col = myColors, pch = rep(16,4), bty = "n", xpd = T,var.col = "red4")
```

# Linear Mixed Effects Model  
I DON'T REMEMBER IF THIS IS CORRECT I WROTE IT ON A PAPER AT THE LAB. I NEED TO CHECK THIS TOMORROW.
```{r lme, echo=FALSE,warning=FALSE,message=FALSE}
# LINEAR MIXED EFFECTS MODEL
library(nlme) #Linear mixed effects models
library(lattice) # plots
d <- data.frame(accuracy)
colnames(d) <- c(0,2,4,8,16,32,64)
d$type <- cases$class
d$id <- rownames(d)
# Selects from 2 to 64
d <- d[,c("type","id","2","4","8","16","32","64")]
d <- reshape(d, direction = "long", varying = list(names(d)[3:8]), v.names = "response", 
        idvar = c("type","id"), timevar = "fts", times = c(2,4,8,16,32,64))
rownames(d) <- NULL

# LME with random intercep
fst.lme <- lme(response~fts+type,
                random=~1|id,
                data=d, method="ML")
# LME with random slope
fst.lme1 <- lme(response~fts+type,
                random=~fts|id,
                data=d, method="ML")
# Plot of the response based on fine structure given the group
xyplot(response~fts | id, data=d, layout=c(2,2))

# ANOVA ob both models
anova(fst.lme, fst.lme1)
summary(fst.lme1)
d$pred1 <- predict(fst.lme1)

# New model with a quadratic expression
fst.lme2 <- lme(response~fts + I(fts^2),
                random=~fts|type,
                data=d, method="ML")
anova(fst.lme1, fst.lme2)
d$pred2 <- predict(fst.lme2)
# FUNCTION to plot the regression and predictors
pfun <- function(x, y){
  panel.xyplot(x,y[1:length(x)])
  panel.lines(x, y[1:length(x) + length(x)], lty=1)}
# Line regression with predicted values from model 1
plot(xyplot(cbind(response, pred1)~fts | type, data = d, panel=pfun, layout=c(2,2)))
# Line regression with predicted values from model 2
dev.new()
plot(xyplot(cbind(response, pred2)~fts | type, data = d, panel=pfun, layout=c(2,2),ylab="Response",xlab="Fine Structure"))

```

# ANOVA  
Is accuracy in the response given by the class belonging and gender?  
```{r anova, echo=TRUE,message=FALSE, warning=FALSE}
mod1 <- aov(accuracy[,1]~factor(cases$class)+factor(cases$gender))
summary(mod1)
TukeyHSD(mod1)
```

